import{getElement as e,store as o}from"@wordpress/interactivity";const{VideoPressIframeApi:s}=window,{state:a,actions:r}=o("prc-block/dialog",{state:{watchedVideos:[],videoPressAPIReady:!1,youTubeAPIReady:!1},actions:{runAnimation:()=>{const{isOpen:s}=a;if(!s)return;const{ref:r}=e(),t=o("prc-block/animation"),i=r.querySelectorAll(".wp-block-prc-block-animation");i.length&&i.forEach(e=>{const o=e.getAttribute("id"),{parentElement:s}=e,a=null!==s?.getAttribute("hidden");o&&!a&&(t.state[o].enabled=!0)})},play:e=>{e&&(a.dialogs[e].videoPressAPI&&a.videoPressAPIReady&&a.dialogs[e].videoPressAPI.controls.play(),a.dialogs[e].youTubePlayer&&a.youTubeAPIReady&&a.dialogs[e].youTubePlayer.playVideo())},pause:e=>{e&&(a.dialogs[e].videoPressAPI&&a.videoPressAPIReady&&a.dialogs[e].videoPressAPI.controls.pause(),a.dialogs[e].youTubePlayer&&a.youTubeAPIReady&&a.dialogs[e].youTubePlayer.pauseVideo())},reset:e=>{e&&(a.dialogs[e].videoPressAPI&&a.videoPressAPIReady&&a.dialogs[e].videoPressAPI.controls.seek(0),a.dialogs[e].youTubePlayer&&a.youTubeAPIReady&&a.dialogs[e].youTubePlayer.seekTo(0))},initVideoPressAPI:async()=>{if(!s)return;const{id:o}=a;if(!o)return;const{ref:r}=e(),t=r.querySelector(".jetpack-videopress-player");if(!t)return;const i=t.querySelector("iframe");if(!i)return;let d=null;const n=s(i,()=>{n.customize.set({shareButton:!1}),n.info.onInfoUpdated(async()=>{d=await n.info.duration()})});a.dialogs[o].videoPressAPI=n,a.videoPressAPIReady=!0,n.status.onPlaybackTimeUpdated(e=>{(e/d*100).toFixed(2)>=70&&!a.watchedVideos.includes(o)&&(a.watchedVideos=[...a.watchedVideos,o])})},initYouTubeAPI:async()=>{const{id:o}=a;if(!o)return;const{ref:s}=e(),r=s.querySelector('iframe[src*="youtube.com/embed/"], iframe[src*="youtu.be/"]');if(r)try{const e=await new Promise((e,o)=>{if(window.YT&&window.YT.Player)return void e(window.YT);window.onYouTubeIframeAPIReady=()=>{e(window.YT)};const s=document.createElement("script");s.src="https://www.youtube.com/iframe_api",s.onload=()=>{},s.onerror=e=>{o(e)},document.head.appendChild(s)}),s=r.src,t=new URL(s);t.search.includes("enablejsapi=1")||(t.searchParams.set("enablejsapi","1"),r.src=t.toString());const i=new e.Player(r,{events:{onReady:e=>{a.youTubeAPIReady=!0},onStateChange:s=>{const r=s.data;r===e.PlayerState.ENDED&&(a.watchedVideos.includes(o)||(a.watchedVideos=[...a.watchedVideos,o])),r===e.PlayerState.PLAYING&&(a.dialogs[o].youTubeProgressInterval&&clearInterval(a.dialogs[o].youTubeProgressInterval),a.dialogs[o].youTubeProgressInterval=setInterval(()=>{const e=a.dialogs[o].youTubePlayer;if(e&&"function"==typeof e.getCurrentTime){const s=(e.getCurrentTime()/e.getDuration()*100).toFixed(2);s>=70&&!a.watchedVideos.includes(o)&&(console.log("Marking YouTube video as watched:",o,s,a.dialogs[o]),a.watchedVideos=[...a.watchedVideos,o],clearInterval(a.dialogs[o].youTubeProgressInterval),a.dialogs[o].youTubeProgressInterval=null)}},2e3)),r!==e.PlayerState.PAUSED&&r!==e.PlayerState.ENDED||a.dialogs[o].youTubeProgressInterval&&(clearInterval(a.dialogs[o].youTubeProgressInterval),a.dialogs[o].youTubeProgressInterval=null)}}});a.dialogs[o].youTubePlayer=i}catch(e){console.error("Error loading YouTube API:",e)}}},callbacks:{onOpenStartVideo:()=>{const{id:e,isOpen:o}=a;e&&o&&r.play(e)},onCloseStopVideo:async()=>{const{id:e,isOpen:o}=a;if(!e)return;const s=void 0!==a.dialogs[e].videoPressAPI||void 0!==a.dialogs[e].youTubePlayer;!o&&s&&(r.pause(e),a.watchedVideos.includes(e))&&r.reset(e)},onVideoInit:async()=>{r.initVideoPressAPI(),r.initYouTubeAPI()}}});
//# sourceMappingURL=view.js.map