import{getContext as e,getElement as t,store as r,withSyncEvent as s}from"@wordpress/interactivity";class o{constructor(e){this.actionUrl=e?.actionUrl,this.message=e.message,this.data=e.data,this.status=e.status}get isSuccess(){return"success"===this.status}get isError(){return"error"===this.status}get isProcessing(){return"processing"===this.status}}const i={STORAGE_KEY_PREFIX:"prc_form_data_",EXPIRY_HOURS:24,getStorageKey(e){return`${this.STORAGE_KEY_PREFIX}${e}`},saveFormData(e,t){try{const r={timestamp:Date.now(),fields:t.filter(e=>e.value&&!["password","hidden"].includes(e.type)).map(e=>({id:e.id,name:e.name,value:e.value,checked:e?.checked||null}))};localStorage.setItem(this.getStorageKey(e),JSON.stringify(r))}catch(e){console.warn("Failed to save form data to localStorage:",e)}},loadFormData(e){try{const t=localStorage.getItem(this.getStorageKey(e));if(!t)return null;const r=JSON.parse(t);return Date.now()>r.timestamp+60*this.EXPIRY_HOURS*60*1e3?(this.clearFormData(e),null):r.fields}catch(e){return console.warn("Failed to load form data from localStorage:",e),null}},clearFormData(e){try{localStorage.removeItem(this.getStorageKey(e))}catch(e){console.warn("Failed to clear form data from localStorage:",e)}},clearExpiredData(){try{const e=Date.now(),t=[];for(let r=0;r<localStorage.length;r++){const s=localStorage.key(r);if(s&&s.startsWith(this.STORAGE_KEY_PREFIX))try{e>JSON.parse(localStorage.getItem(s)).timestamp+60*this.EXPIRY_HOURS*60*1e3&&t.push(s)}catch(e){t.push(s)}}t.forEach(e=>localStorage.removeItem(e))}catch(e){console.warn("Failed to clear expired form data:",e)}}},{state:n,actions:a}=r("prc-block/form",{state:{success:!1,error:!1,processing:!1,get submissionDisabled(){return!e().allowSubmit},get fieldsForSubmission(){const t=e(),{formFields:r}=t,s=n.formFields.filter(e=>r.includes(e.id));return s.push({id:"captchaToken",type:"captchaToken",value:t.captchaToken,required:!1,name:"captchaToken"}),s},get inputType(){e();const{attributes:r}=t(),{id:s}=r,{formFields:o}=n;return o.find(e=>e.id===s)?.type},get inputValue(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.value},get inputName(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.name},get inputPlaceholder(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.placeholder},get isInputHidden(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.hidden},get isInputDisabled(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.disabled},get isInputReadOnly(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.readOnly},get isInputRequired(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.required},get isInputChecked(){const{attributes:e}=t(),{id:r}=e,{formFields:s}=n;return s.find(e=>e.id===r)?.checked},get isInputError(){const{formFields:e}=n,{attributes:r}=t(),{id:s}=r;return e.find(e=>e.id===s)?.error||n.error},get isInputSuccess(){return n.success},get isInputProcessing(){return n.processing},get hasErrors(){return e().errors.length>0},get formMessage(){const t=e();return t?.formMessage||!1}},actions:{updateInputStateProp:(t,r,s)=>{const{formFields:o}=n,a=o.find(e=>e.id===t);a&&(a[r]=s);const{formId:c}=e();n.formFields=o,i.saveFormData(c,o)},onLabelClick:s(e=>{const t=e.target.nextElementSibling;t&&["INPUT","SELECT","TEXTAREA"].includes(t.tagName)&&t.focus()}),getInputStateProp:(e,t)=>{const{formFields:r}=n;return r.find(t=>t.id===e)?.[t]},onInputChange:s(e=>{const{value:t,id:r}=e.target;a.updateInputStateProp(r,"value",t),a.updateInputStateProp(r,"error",!1)}),onInputCheckboxClick:s(e=>{const{checked:t,id:r}=e.target;a.updateInputStateProp(r,"checked",t),a.updateInputStateProp(r,"error",!1)}),onInputFocus:s(e=>{const{id:t}=e.target;a.updateInputStateProp(t,"error",!1)}),onInputBlur:s(e=>{}),onInputMouseEnter:s(e=>{}),onInputMouseLeave:s(e=>{}),checkForRequiredFieldsWithoutValues:()=>{const t=e(),{fieldsForSubmission:r}=n;let s=!1;r.forEach(e=>{!e.required||("checkbox"===e.type||"radio"===e.type?e.checked:e.value)?a.updateInputStateProp(e.id,"error",!1):(a.updateInputStateProp(e.id,"error",!0),s=!0)}),t.stopProcessing=s},onSubmit:s(async t=>{t.preventDefault();const r=e();a.checkForRequiredFieldsWithoutValues(),r.stopProcessing||(r.submissionProcessing=null,r.captchaHidden=!1)}),onReset:()=>{const t=e();t.submissionProcessing=!1,t.captchaHidden=!0,t.submitButtonText="Submit",t.stopProcessing=!1,t.allowSubmit=!0,t.errors=[],t._isSubmitting=!1,i.clearFormData(t.formId)},onErrorClick:s(e=>{e.preventDefault();const{actionUrl:t}=e.target.dataset;t&&(window.location.href=t),a.onReset()})},callbacks:{onFormMount:()=>{const{ref:r,attributes:s}=t();let{id:o}=s;o||(o=`prc-block-form-${Math.random().toString(36).substring(2,15)}`);const a=(e=>{const t=e.querySelectorAll("input, select, textarea, .wp-block-prc-block-form-input-password"),r=[];return t.forEach(e=>{"password"!==e.type&&e.id&&r.push(e.id)}),r})(r),c=e();c.formId=o,c.formFields=a,i.clearExpiredData();const u=i.loadFormData(o);u&&(n.formFields=n.formFields.map(e=>{const t=u.find(t=>t.id===e.id);return t&&(e.value=t?.value,e.checked=t?.checked),e}))},onCaptchaPassing:()=>{const t=e();t.captchaPassed&&(t.captchaHidden=!0)},onProcessing:()=>{const t=e();t.submissionProcessing?t.submitButtonText="Processing...":t.submitButtonText="Submit"},*sendSubmission(){const t=e(),{captchaPassed:s,captchaToken:a,nonceName:c,nonceToken:u,submissionProcessing:d,stopProcessing:l,submitMethod:m,formId:p,formName:g,redirectUrl:f}=t;if(!s||l||!1===d||!0===d||t._isSubmitting)return;t._isSubmitting=!0,t.captchaHidden=!0,t.submissionProcessing=!0;const{method:h,action:S,namespace:b}=m,{fieldsForSubmission:F}=n,I=[...F,{id:"nonce",name:c,type:"nonceToken",value:u}];if("rest"===h){const e=S.replace(/([A-Z])/g,"-$1").toLowerCase();try{const r=yield window.wp.apiFetch({path:`/prc-api/v3/form/${e}?nonce=${u}`,method:"POST",data:{formName:g,formId:p,redirectTarget:f,formFields:I}}),s=new o(r);s.isSuccess?(n.success=!0,t.formMessage=s?.message||"Form submitted successfully."):n.error=!0}catch(e){console.error("onSubmit (REST) error:",e),n.error=!0,t.errors.push({id:`error-${Math.random().toString(36).substring(2,15)}`,message:e?.message||"An error occurred.",actionUrl:e?.actionUrl||null})}t.submissionProcessing=!1,t._isSubmitting=!1}else if("api"===h){const e=yield r(b);if(e?.actions[S])try{const r=yield e.actions[S](I),s=new o(r);s.isSuccess?(i.clearFormData(p),n.success=!0,f?window.location.href=f:t.formMessage=s?.message||"Form submitted successfully.",s.actionUrl&&setTimeout(()=>{window.location.href=s.actionUrl},1e3)):(n.error=!0,t.errors.push({id:`error-${Math.random().toString(36).substring(2,15)}`,message:s?.message||"An error occurred.",actionUrl:s?.actionUrl||null}))}catch(e){console.error("onSubmit error",e),n.error=!0,t.errors.push({id:`error-${Math.random().toString(36).substring(2,15)}`,message:e?.message||"An error occurred.",actionUrl:e?.actionUrl||null})}finally{t.submissionProcessing=!1,t._isSubmitting=!1}}i.clearFormData(p)}}});
//# sourceMappingURL=index.js.map